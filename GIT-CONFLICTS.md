# Решение Git конфликтов в Neovim

## Плагины для работы с Git конфликтами

В вашей конфигурации установлены:
- **git-conflict.nvim** - удобное разрешение конфликтов прямо в буфере
- **diffview.nvim** - визуальный просмотр diff и конфликтов
- **gitsigns.nvim** - показывает изменения в файлах

## Основные горячие клавиши

### Навигация по конфликтам

| Клавиша | Действие |
|---------|----------|
| `]x` | Перейти к следующему конфликту |
| `[x` | Перейти к предыдущему конфликту |

### Разрешение конфликтов

| Клавиша | Действие | Описание |
|---------|----------|----------|
| `<leader>go` | Choose Ours | Оставить нашу версию (текущая ветка) |
| `<leader>gt` | Choose Theirs | Взять их версию (входящая ветка) |
| `<leader>gb` | Choose Both | Оставить обе версии |
| `<leader>gn` | Choose None | Удалить обе версии (очистить) |

### Просмотр изменений (Diffview)

| Клавиша | Действие |
|---------|----------|
| `<leader>dv` | Открыть Diffview (все изменения) |
| `<leader>dh` | Открыть историю файла |
| `<leader>dc` | Закрыть Diffview |

### Git изменения (Gitsigns)

| Клавиша | Действие |
|---------|----------|
| `]c` | Следующее изменение (hunk) |
| `[c` | Предыдущее изменение (hunk) |
| `<leader>hs` | Stage hunk |
| `<leader>hu` | Undo stage hunk |
| `<leader>hr` | Reset hunk |
| `<leader>hp` | Preview hunk |
| `<leader>hb` | Показать blame для строки |
| `<leader>hd` | Показать diff для файла |

## Типичные сценарии

### Сценарий 1: Простое разрешение конфликта

**Ситуация**: После `git merge` или `git pull` появились конфликты в файле.

**Как выглядит конфликт в файле**:
```go
func DoSomething() {
<<<<<<< HEAD
    // Наша версия (текущая ветка)
    fmt.Println("Version A")
=======
    // Их версия (входящая ветка)
    fmt.Println("Version B")
>>>>>>> feature-branch
}
```

**Шаги**:
1. Откройте файл с конфликтом
2. Neovim подсветит конфликтные блоки
3. Используйте `]x` для перехода к конфликту
4. Выберите нужное действие:
   - `<leader>go` - если хотите оставить свою версию
   - `<leader>gt` - если хотите взять их версию
   - `<leader>gb` - если нужны обе версии
   - `<leader>gn` - если нужно удалить обе и написать новое
5. Повторите для всех конфликтов (используйте `]x` для навигации)
6. Сохраните файл `:w`
7. Добавьте в git: `git add <file>`
8. Завершите merge: `git commit`

### Сценарий 2: Множественные конфликты в файле

**Ситуация**: В одном файле много конфликтов.

**Шаги**:
1. Откройте файл
2. Используйте `]x` для перехода к первому конфликту
3. Разрешите его одной из команд (`<leader>go/gt/gb/gn`)
4. Нажмите `]x` снова для перехода к следующему
5. Повторяйте, пока все конфликты не будут разрешены
6. `:w` для сохранения

### Сценарий 3: Сложный конфликт с ручным редактированием

**Ситуация**: Ни одна из версий не подходит, нужно комбинировать код вручную.

**Шаги**:
1. Перейдите к конфликту с помощью `]x`
2. Нажмите `<leader>gn` чтобы очистить обе версии
3. Вручную напишите правильный код
4. Сохраните и продолжайте

### Сценарий 4: Визуальный просмотр изменений

**Ситуация**: Хотите увидеть все изменения визуально перед разрешением.

**Шаги**:
1. В файле с конфликтом нажмите `<leader>dv`
2. Откроется Diffview с 3-way diff:
   - Левая панель: OURS (наша версия)
   - Центр: WORKING COPY (рабочая копия с конфликтами)
   - Правая панель: THEIRS (их версия)
3. В центральной панели можно редактировать файл
4. Закройте Diffview: `<leader>dc`
5. Продолжайте разрешать конфликты в основном файле

### Сценарий 5: Конфликты после rebase

**Ситуация**: `git rebase` привел к конфликтам на нескольких коммитах.

**Шаги**:
1. Разрешите конфликты в текущих файлах (как в Сценарии 1)
2. Сохраните все файлы
3. В терминале: `git add .`
4. Продолжите rebase: `git rebase --continue`
5. Если появятся новые конфликты - повторите процесс
6. Для отмены rebase: `git rebase --abort`

## Полезные команды в терминале Neovim

Откройте встроенный терминал: `<leader>cc` (ClaudeCode) или `:terminal`

### Проверка статуса конфликтов

```bash
# Показать файлы с конфликтами
git status

# Показать список конфликтов
git diff --name-only --diff-filter=U

# Посмотреть конфликты в терминале
git diff
```

### Разрешение конфликтов через git

```bash
# Взять нашу версию для файла целиком
git checkout --ours путь/к/файлу

# Взять их версию для файла целиком
git checkout --theirs путь/к/файлу

# После разрешения всех конфликтов
git add .
git commit -m "Resolve merge conflicts"
```

### Полезные alias для .gitconfig

```ini
[alias]
    # Показать конфликтные файлы
    conflicts = diff --name-only --diff-filter=U

    # Взять нашу версию для всех конфликтов
    ours = "!f() { git checkout --ours $@ && git add $@; }; f"

    # Взять их версию для всех конфликтов
    theirs = "!f() { git checkout --theirs $@ && git add $@; }; f"
```

## Workflow: От конфликта до коммита

### 1. Обнаружение конфликта

```bash
git pull origin main
# или
git merge feature-branch
# или
git rebase main
```

Получите сообщение:
```
CONFLICT (content): Merge conflict in file.go
Automatic merge failed; fix conflicts and then commit the result.
```

### 2. Открытие файлов с конфликтами в Neovim

```bash
# Посмотреть список конфликтных файлов
git conflicts  # если настроили alias

# Открыть в Neovim
nvim $(git diff --name-only --diff-filter=U)
```

Или через Telescope в Neovim:
- `<leader>ff` - найти файл
- Откройте файл с конфликтом

### 3. Разрешение конфликтов

В каждом файле:
1. `]x` - перейти к конфликту
2. Выбрать действие:
   - `<leader>go` - наша версия
   - `<leader>gt` - их версия
   - `<leader>gb` - обе версии
   - `<leader>gn` - очистить и написать вручную
3. Повторить для всех конфликтов
4. `:w` - сохранить

### 4. Проверка результата

```vim
" В Neovim откройте Diffview
<leader>dv
```

Или в терминале:
```bash
git diff
```

### 5. Коммит изменений

```bash
# Добавить разрешенные файлы
git add путь/к/файлу
# или все сразу
git add .

# Закончить merge
git commit
# Git автоматически предложит сообщение о merge

# Или при rebase
git rebase --continue
```

### 6. Отправка в remote

```bash
git push origin your-branch
```

## Визуальные индикаторы в Neovim

### git-conflict.nvim подсветка

Конфликты подсвечиваются разными цветами:
- **Текущая версия (OURS)** - обычно синим
- **Входящая версия (THEIRS)** - обычно зеленым
- **Маркеры конфликтов** - обычно красным

### gitsigns индикаторы в колонке слева

- `│` - измененная строка
- `┃` - добавленная строка
- `▁` - удаленная строка

## Советы и трюки

### 1. Быстрое разрешение однотипных конфликтов

Если много файлов с одинаковым типом конфликта:

```bash
# Взять нашу версию для всех .go файлов
git checkout --ours '*.go'
git add '*.go'

# Взять их версию для всех .md файлов
git checkout --theirs '*.md'
git add '*.md'
```

### 2. Отмена разрешения конфликта

Если ошибочно разрешили конфликт:

```bash
# Вернуть файл в конфликтное состояние
git checkout -m путь/к/файлу
```

### 3. Использование vimdiff (встроенно в Git)

```bash
# Открыть конфликт в vimdiff
git mergetool
```

Но наша конфигурация Neovim удобнее!

### 4. Предотвращение конфликтов

```bash
# Частый pull изменений
git pull --rebase origin main

# Работа в feature branches
git checkout -b feature-name

# Частые коммиты
git commit -am "Small incremental change"
```

### 5. Макрос для быстрого разрешения

Создайте макрос в Neovim для повторяющихся действий:

```vim
" В normal mode
qa              " Начать запись макроса в регистр 'a'
]x              " Перейти к конфликту
<leader>go      " Выбрать нашу версию
q               " Закончить запись

" Применить макрос
@a              " Применить один раз
10@a            " Применить 10 раз для 10 конфликтов
```

## Troubleshooting

### Проблема: Конфликты не подсвечиваются

**Решение**:
```vim
:Lazy reload git-conflict.nvim
```

### Проблема: Не работают горячие клавиши

**Проверка**:
```vim
:checkhealth
:map <leader>go
```

### Проблема: Слишком много конфликтов

**Решение**: Отмените merge и сделайте частичный merge:
```bash
git merge --abort
git merge --no-commit --no-ff branch-name
# Разрешите конфликты порциями
```

## Дополнительные ресурсы

- `:help git-conflict` - помощь по плагину
- `:help diffview` - помощь по Diffview
- `:help gitsigns` - помощь по Gitsigns
- `<leader>?` - показать все локальные горячие клавиши (which-key)

## Быстрая шпаргалка

```
НАВИГАЦИЯ:
]x / [x          - следующий/предыдущий конфликт
]c / [c          - следующее/предыдущее изменение

РАЗРЕШЕНИЕ:
<leader>go       - взять OURS (нашу версию)
<leader>gt       - взять THEIRS (их версию)
<leader>gb       - взять BOTH (обе версии)
<leader>gn       - взять NONE (очистить)

ПРОСМОТР:
<leader>dv       - открыть Diffview
<leader>hp       - preview изменений
<leader>hb       - git blame строки

ТЕРМИНАЛ:
git status       - статус конфликтов
git add .        - добавить разрешенные
git commit       - закончить merge
```

---

**Совет**: Начните с простых конфликтов, используя `<leader>go` или `<leader>gt`. По мере практики вы освоите более сложные сценарии с ручным редактированием и Diffview.
